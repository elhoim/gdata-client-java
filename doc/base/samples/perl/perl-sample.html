<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="stylesheet" type="text/css" href="../../../css/google.css" />
<link rel="stylesheet" type="text/css" href="../../../css/dev_docs.css" />
<link rel="stylesheet" type="text/css" href="../../local_extensions.css" />
<!--[if IE 7]>
  <link rel="stylesheet" type="text/css" href="../../../css/ie7only.css" />
<![endif]-->
<!--[if lte IE 6]>
  <link rel="stylesheet" type="text/css" href="../../../css/ie6only.css" />
<![endif]-->
<!--[if IE]>
  <link rel="stylesheet" type="text/css" href="../../../css/ieonly.css" />
<![endif]-->
<title>Google Base data API- Accessing the Google Base data API using Perl</title>
</head>
<body id="sample_page">
<a name="top" id="top"></a>
<!-- ########## PAGE HEADER ########## -->
<div id="header">
  <div id="logo"><a href="http://code.google.com/"><img src="http://code.google.com/images/code_sm.png" border="0" alt="Return to Google Code homepage" /></a></div>
  <h1 id="doc_title">Google Base data API</h1>
</div>
<!-- ########## END PAGE HEADER ########## -->
<div id="wrapper">
  <!-- ########## SIDE NAVIGATION ########## -->
    <div id="sidenav"> <!-- ID tag identifies current page -->

<ul>
  <li><a href="http://base.google.com/base">Base Home</a></li>
  <li><a href="../../index.html" id="index_link">Base API Home</a></li>
</ul>
<ul>
  <li>
    <h1>Getting Started</h1>
    <ul>
      <li><a href="http://www.google.com/base/api/demo/html/demo.html" id="demo_link">API Demo Page</a> </li>
      <li><a href="../../sample-apps.html" id="sample_link">Sample Applications</a></li>
      <li><a href="../../starting-out.html" id="start_link">Getting Started</a></li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <h1>Developer's Guide</h1>
    <ul>
      <li><a href="../../attrs-queries.html" id="attsquer_link">Attributes and Queries</a></li>
      <li><a href="http://code.google.com/apis/gdata/index.html">GData Developer's Guide</a></li>
      <li><a href="../../javadevguide.html" id="javaDev_link">Java Developer's Guide</a></li>
      <li><a href="../../csharpdevguide.html" id="cSharpDev_link">C# Developer's Guide</a></li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <h1>Reference</h1>
    <ul>
      <li><a href="http://base.google.com/base/api/itemTypeDocs" id="itemType_link">Recommended
        Attributes</a></li>
      <li><a href="../../snippets-feed.html" id="snippets_link">Snippets
        Feed</a></li>
      <li><a href="../../items-feed.html" id="items_link">Customer Items
        Feed</a></li>
      <li><a href="../../attributes-feed.html" id="attributes_link">Attributes
        Feed</a></li>
      <li><a href="../../itemtypes-feed.html" id="itemtypes_link">Item Types
        Feed</a></li>
      <li><a href="../../locales-feed.html" id="locales_link">Locales Feed</a></li>
      <li><a href="../../query-lang-spec.html" id="query_link">Query Language</a></li>
      <li><a href="../../ranking-lang-spec.html" id="ranking_link">Expression Language</a></li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <h1>Related Links</h1>
    <ul>
      <li><a href="../../client-download.html" id="clientdownload_link">Client
        Library </a></li>
      <li><a href="../../signup.html" id="signup_link">API Key</a></li>
      <li><a href="../../terms.html" id="terms_link">Terms of Use</a></li>
      <li><a href="../../release-notes.html" id="rnotes_link">Release Notes </a></li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <h1>Help Center</h1>
    <ul>
      <li><a href="http://base.google.com/support/bin/topic.py?topic=9231">FAQ</a></li>
      <li><a href="http://groups.google.com/group/Google-Base-data-API">Developer Forum</a></li>
      <li><a href="http://code.google.com/support/bin/topic.py?topic=10024">Knowledge Base</a> </li>
      <li><a href="http://base.google.com/base/base_policies.html">Program Policies</a></li>
      </ul>
  </li>
</ul>
<form action="http://www.google.com/search" method="get" id="searchbox" style="font-size: 80%; margin-bottom: 0;">
  <input type="text" name="q" size="15" id="searchinput" title="Search developer's guide" style="font-size: 100%;"
		onfocus="clearDefaultValue(this);"/>
  <!-- This comment prevents 
	space-->
  <input type="submit" name="submit" value="Go" title="" style="font-size: 90%;"/>
  <input type="hidden" name="ie" value="UTF-8"/>
  <input type="hidden" name="oe" value="UTF-8"/>
  <input type="hidden" name="sitesearch" value="http://code.google.com/apis/base/"/>
  <input type="hidden" name="domains" value="http://code.google.com/apis/base/"/>
</form>
 </div>
  <!-- ########## END SIDE NAVIGATION ########## -->
<div id="pagecontent">
    <!-- ########## PAGE CONTENT ########## -->
    <h2 id="page_title">Accessing the Google Base data API using Perl</h2>
    <p><strong>Select a language:</strong> | <a href="../java/java-sample.html">Java</a> | <a href="../javascript/javascript-sample.html">JavaScript</a> |<activeLang><strong> Perl </strong></activelang>| <a href="../php/php-sample-zend.html">PHP</a> | <a href="../python/python-sample.html">Python</a> | <a href="../csharp/csharp-sample.html">C#</a> | <a href="../vb/vb-sample.html">VB.NET</a> | <a href="../coldfusion/coldfusion-sample.html">ColdFusion</a> </p>  
    <p>The Perl Recipe application is a small but complete example that demonstrates the five Google Base API services: queries, insertions, deletions, updates, and batch commands. It uses the standard <a href="http://curl.haxx.se/libcurl">libcurl</a> library to perform efficient HTTP requests for authentication and interaction with Google Base API.</p>
     <h3>Contents</h3>
    <ol class="toc">
	  <li><a href="#usingRecipe">Using the Recipe application </a></li>
      <li><a href="#RSstepThru">Stepping through the Recipe application code</a>
      <ol class="toc">
        <li><a href="#setup">Setup and token exchange</a>
        <ol class="toc">
          <li><a href="#introPage">Building the introductory page</a></li>
          <li><a href="#exchangeToken">Exchanging the single-session token</a></li>
        </ol></li>
        <li><a href="#xml">Constructing XML requests and parsing XML responses </a>
        <ol class="toc">
          <li><a href="#itemXML">Creating the item insertion request</a></li>
          <li><a href="#deleteXML">Creating the batch deletion request</a></li>
          <li><a href="#responseXML">Parsing the user's items feed</a></li>
        </ol></li>
        <li><a href="#FeedInteract">Interacting with the Google Base feed </a>
        <ol class="toc">
          <li><a href="#queryEntries">Retrieving the user's entries</a></li>
          <li><a href="#insertEntry">Inserting new entries</a></li>
          <li><a href="#updateEntry">Updating existing entries</a> </li>
          <li><a href="#deleteEntry">Deleting existing entries</a></li>
          <li><a href="#batchCommand">Executing a batch command</a></li>
        </ol></li>
      </ol></li>
      <li><a href="#troubleshooting">Troubleshooting</a></li>
    </ol>
    <h2><a name="usingRecipe" id="usingRecipe"></a>Using the Recipe application </h2>
    <p>You can <a href="demo.pl.txt">download the source code</a> for the sample program and host it on your own web server. Note that this application is a web application and is not intended to be run from the command line. </p>
    <p>We have tested the Recipe application with the latest versions of <code><a href="http://search.cpan.org/~crisb/WWW-Curl-3.02">WWW::Curl::Easy</a></code><a href="http://search.cpan.org/~crisb/WWW-Curl-3.02"></a> (version 3.02) and <code><a href="http://search.cpan.org/~msergeant/XML-Parser-2.34">XML::Parser</a></code><a href="http://search.cpan.org/~msergeant/XML-Parser-2.34"></a> (version 2.34).&nbsp; These Perl modules provide support for executing HTTP requests and parsing XML documents, respectively.</p>
    <p>After installing the Perl sample application, replace line 10 with a valid API Key tied to your domain.</p>
    <p>When you first use the Recipe application, you will have to log in to your Google Account and grant the script permission to access your Google Base entries.</p>
    <h2><a name="RSstepThru" id="RSstepThru"></a>Stepping through the Recipe application code </h2>
    <p>The Recipe application allows users to upload new recipes to Google Base, edit or delete recipes they have already added, or delete all their recipes with a batch request. It uses GET and POST parameters to maintain two key elements of program state: the user's <b>AuthSub token</b> and <b>requested action</b> (insert, update, delete, or batch).</p>
    <h3><a name="setup" id="setup"></a>Setup and token exchange</h3>
    <p>This section describes how the Recipe application initially interacts with the user and obtains a session token from the AuthSub server.</p>
    <h4><a name="introPage" id="introPage"></a>Building the introductory page: <code>showIntroPage()</code></h4>
    <p>When a user first arrives at the Recipe application, no GET or POST parameters are provided to the form. This indicates that the user has not yet obtained a single-session token. The code below sets up a link to the <code><a href="http://code.google.com/apis/accounts/AuthForWebApps.html#AuthSubRequest">AuthSubRequest</a></code> page with these options:</p>
    <ul>
      <li><b>session</b>, indicating this token can be exchanged for a multi-use (session) token;</li>
      <li><b>next</b>, with a link back to the Recipe application;</li>
      <li><b>scope</b>, indicating that the Recipe application will only access the items feed.</li>
    </ul>
    <pre>sub&nbsp;showIntroPage&nbsp;{
&nbsp;&nbsp;my&nbsp;$redirect_url&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;'https://www.google.com/accounts/AuthSubRequest?session=1';
&nbsp;&nbsp;$redirect_url&nbsp;.=&nbsp;'&amp;next=';
&nbsp;&nbsp;$redirect_url&nbsp;.=&nbsp;uri_escape(getSelfURI());
&nbsp;&nbsp;$redirect_url&nbsp;.=&nbsp;&quot;&amp;scope=&quot;;
&nbsp;&nbsp;$redirect_url&nbsp;.=&nbsp;uri_escape(&quot;http://www.google.com/base/feeds&quot;);

&nbsp;&nbsp;...

}</pre>
    <p>The remainder of <code>showIntroPage</code> (omitted for brevity) prints the HTML tags to create a table containing this link.</p>
    <h4><a name="exchangeToken" id="exchangeToken"></a>Exchanging the single-session token: <code>exchangeToken()</code></h4>
    <p>After the user authenticates to his Google Account using AuthSub, he is redirected back to the Recipe application page (as a result of the <code>next</code> parameter to <code>AuthSubRequest</code>). The redirection URL will contain one GET parameter: the single-use token granted by AuthSub.</p>
    <p>The <code>exchangeToken()</code> function below is used to exchange the user's single-use token for a multi-use (session) token.  The resulting session token is used for all interaction with the Google Base API: queries, insertions, deletions, updates, and batch commands. <code>exchangeToken()</code> uses the standard procedure for performing an HTTP request with libcurl, namely: </p>
    <ol>
      <li>Create a handle for the request with <code>new WWW:Curl::Easy </code>.</li>
      <li>Set the options for the request with <code>$curl-&gt;setopt()</code>. In this case, we specify the <code><a href="http://code.google.com/apis/accounts/AuthForWebApps.html#AuthSubSessionToken">AuthSubSessionToken</a></code> URL (<code>CURLOPT_URL</code>) as well as the single-use AuthSub token (<code>CURLOPT_HTTPHEADER</code>). We also request that the HTTP response be returned rather than printed directly (<code>CURLOPT_RETURNTRANSFER</code>) and that the request should fail silently if an error occurs (<code>CURLOPT_FAILONERROR</code>).</li>
      <li>Execute the request with <code>$curl-&gt;perform()</code> and catch the result.</li>
      <li>Note that, unlike the PHP sample application, there is no need to manually close the cURL handle; Perl does this automatically. </li>
    </ol>
    <p>Finally, the HTTP response (<code>Token=...</code>) is parsed with the <code><a href="http://www.php.net/manual/en/function.split.php">split()</a></code> function and the result returned.</p>
    <pre>sub&nbsp;exchangeToken&nbsp;{
&nbsp;&nbsp;my&nbsp;$token&nbsp;=&nbsp;shift;
&nbsp;&nbsp;my&nbsp;$curl&nbsp;=&nbsp;new&nbsp;WWW::Curl::Easy;
&nbsp;&nbsp;my&nbsp;@body;

&nbsp;&nbsp;my&nbsp;@authHeader&nbsp;=&nbsp;(&quot;Authorization:&nbsp;AuthSub&nbsp;token=\&quot;&quot;&nbsp;.&nbsp;$token&nbsp;.&nbsp;&quot;\&quot;&quot;);

&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_URL,
&nbsp;&nbsp;&nbsp;&nbsp;&quot;https://www.google.com/accounts/AuthSubSessionToken&quot;);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_FAILONERROR,&nbsp;1);&nbsp;

&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_WRITEFUNCTION,&nbsp;\&amp;writeCallback&nbsp;);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_HEADERFUNCTION,&nbsp;\&amp;headerCallback&nbsp;);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_FILE,&nbsp;\@body);

&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_FOLLOWLOCATION,&nbsp;1);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_HTTPHEADER,&nbsp;\@authHeader);

&nbsp;&nbsp;my&nbsp;$result&nbsp;=&nbsp;$curl-&gt;perform();

&nbsp;&nbsp;if&nbsp;($result&nbsp;&gt;&nbsp;0)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Extract&nbsp;everything&nbsp;to&nbsp;the&nbsp;right&nbsp;of&nbsp;the&nbsp;equals&nbsp;sign&nbsp;in
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;the&nbsp;response&nbsp;&quot;Token=...&quot;
&nbsp;&nbsp;&nbsp;&nbsp;my&nbsp;@splitStr&nbsp;=&nbsp;split(/=/,&nbsp;$body[0]);
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;trim($splitStr[1]);
&nbsp;&nbsp;}
}</pre>
    <h3><a name="xml" id="xml"></a>Constructing XML requests and parsing XML responses </h3>
    <p>This section describes how the Recipe application builds XML requests to be sent to the Google Base feed and how it parses the XML responses.</p>
    <h4><a name="itemXML" id="itemXML"></a>Creating the item insertion request: <code>buildInsertXML()</code></h4>
    <p>The <code>buildInsertXML()</code> function  is used to construct the XML document that is sent when the user inserts a new recipe. It simply formats the POST fields submitted by the user (<code>recipe_title</code>, <code>cuisine</code>, and so forth) to conform to the <a href="http://code.google.com/apis/base/concepts.html#namespaces">Atom format for a single entry</a>.</p>
    <pre>sub&nbsp;buildInsertXML&nbsp;{
&nbsp;&nbsp;my&nbsp;$result&nbsp;=&nbsp;&quot;&lt;?xml&nbsp;version='1.0'?&gt;&quot;&nbsp;.&nbsp;&quot;\n&quot;;
&nbsp;&nbsp;$result&nbsp;.=&nbsp;&quot;&lt;entry&nbsp;xmlns='http://www.w3.org/2005/Atom'&quot;&nbsp;.
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&nbsp;xmlns:g='http://base.google.com/ns/1.0'&gt;&quot;&nbsp;.&nbsp;&quot;\n&quot;;
&nbsp;&nbsp;$result&nbsp;.=&nbsp;&quot;&lt;category&nbsp;scheme='http://base.google.com/categories/itemtypes'&quot;&nbsp;.
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&nbsp;term='Recipes'/&gt;&quot;&nbsp;.&nbsp;&quot;\n&quot;;
&nbsp;&nbsp;$result&nbsp;.=&nbsp;&quot;&lt;title&nbsp;type='text'&gt;&quot;&nbsp;.&nbsp;param('recipe_title')&nbsp;.&nbsp;&quot;&lt;/title&gt;&quot;&nbsp;.&nbsp;&quot;\n&quot;;
&nbsp;&nbsp;$result&nbsp;.=&nbsp;&quot;&lt;g:cuisine&gt;&quot;&nbsp;.&nbsp;param('cuisine')&nbsp;.&nbsp;&quot;&lt;/g:cuisine&gt;&quot;&nbsp;.&nbsp;&quot;\n&quot;;
&nbsp;&nbsp;$result&nbsp;.=&nbsp;&quot;&lt;g:item_type&nbsp;type='text'&gt;Recipes&lt;/g:item_type&gt;&quot;&nbsp;.&nbsp;&quot;\n&quot;;
&nbsp;&nbsp;$result&nbsp;.=&nbsp;&quot;&lt;g:cooking_time&nbsp;type='intUnit'&gt;&quot;&nbsp;.&nbsp;param('cooking_time_val')&nbsp;.
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&nbsp;&quot;&nbsp;.&nbsp;param('cooking_time_units')&nbsp;.&nbsp;&quot;&lt;/g:cooking_time&gt;&quot;&nbsp;.&nbsp;&quot;\n&quot;;
&nbsp;&nbsp;$result&nbsp;.=&nbsp;&quot;&lt;g:main_ingredient&nbsp;type='text'&gt;&quot;&nbsp;.&nbsp;param('main_ingredient')&nbsp;.
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;/g:main_ingredient&gt;&quot;&nbsp;.&nbsp;&quot;\n&quot;;
&nbsp;&nbsp;$result&nbsp;.=&nbsp;&quot;&lt;g:serving_count&nbsp;type='number'&gt;&quot;&nbsp;.&nbsp;param('serves')&nbsp;.
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&lt;/g:serving_count&gt;&quot;&nbsp;.&nbsp;&quot;\n&quot;;
&nbsp;&nbsp;$result&nbsp;.=&nbsp;&quot;&lt;content&gt;&quot;&nbsp;.&nbsp;param('recipe_text')&nbsp;.&nbsp;&quot;&lt;/content&gt;&quot;&nbsp;.&nbsp;&quot;\n&quot;;
&nbsp;&nbsp;$result&nbsp;.=&nbsp;&quot;&lt;/entry&gt;&quot;&nbsp;.&nbsp;&quot;\n&quot;;

&nbsp;&nbsp;return&nbsp;$result;
}
</pre>
    <h4><a name="deleteXML" id="deleteXML"></a>Creating the batch deletion request: <code>buildBatchXML()</code></h4>
    <p>The <code>buildBatchDeleteXML ()</code> function creates the XML document used to perform a batch deletion request. It formats the links to each item's feed URI (submitted as POST fields when the user clicks the <strong>Delete All</strong> button) into the <a href="http://code.google.com/apis/base/sample-apps.html#CTbatch">Atom format for batch processing</a>.</p>
    <pre>sub&nbsp;buildBatchDeleteXML&nbsp;{
&nbsp;&nbsp;my&nbsp;$counter&nbsp;=&nbsp;0;

&nbsp;&nbsp;my&nbsp;$result&nbsp;=&nbsp;'&lt;?xml&nbsp;version=&quot;1.0&quot;&nbsp;encoding=&quot;UTF-8&quot;?&gt;'&nbsp;.&nbsp;&quot;\n&quot;;
&nbsp;&nbsp;$result&nbsp;.=&nbsp;'&lt;feed&nbsp;xmlns=&quot;http://www.w3.org/2005/Atom&quot;'&nbsp;.&nbsp;&quot;\n&quot;;
&nbsp;&nbsp;$result&nbsp;.=&nbsp;'&nbsp;xmlns:g=&quot;http://base.google.com/ns/1.0&quot;'&nbsp;.&nbsp;&quot;\n&quot;;
&nbsp;&nbsp;$result&nbsp;.=&nbsp;'&nbsp;xmlns:batch=&quot;http://schemas.google.com/gdata/batch&quot;&gt;&quot;'&nbsp;.&nbsp;&quot;\n&quot;;
&nbsp;&nbsp;for&nbsp;my&nbsp;$key&nbsp;(param())&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(index($key,&nbsp;&quot;link_&quot;)&nbsp;==&nbsp;0)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$counter++;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;.=&nbsp;'&lt;entry&gt;'&nbsp;.&nbsp;&quot;\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;.=&nbsp;'&lt;id&gt;'&nbsp;.&nbsp;param($key)&nbsp;.&nbsp;'&lt;/id&gt;'&nbsp;.&nbsp;&quot;\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;.=&nbsp;'&lt;batch:operation&nbsp;type=&quot;delete&quot;/&gt;'&nbsp;.&nbsp;&quot;\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;.=&nbsp;'&lt;batch:id&gt;'&nbsp;.&nbsp;$counter&nbsp;.&nbsp;'&lt;/batch:id&gt;'&nbsp;.&nbsp;&quot;\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result&nbsp;.=&nbsp;'&lt;/entry&gt;'&nbsp;.&nbsp;&quot;\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;}
&nbsp;&nbsp;$result&nbsp;.=&nbsp;'&lt;/feed&gt;'&nbsp;.&nbsp;&quot;\n&quot;;

&nbsp;&nbsp;return&nbsp;$result;
}
</pre>
    <h4><a name="responseXML" id="responseXML"></a>Parsing the user's items feed</h4>
    <p>The Recipe application uses the XML::Parser module to parse the user's <a href="http://code.google.com/apis/base/items-feed.html">items feed</a> into an internal array of entries.  This function executes three provided handlers, or callback functions, as it parses an XML document: one when a start tag is read (<code>handleXMLstart()</code>), one when an end tag is read (<code>handleXMLend()</code>) and one when character data is read (<code>handleXMLchar()</code>). These handlers coordinate using the following global variables:</p>
    <ul>
      <li><code>$parsedEntries</code> (array)<br />
        contains the array of user-entered recipes. This variable is actually an array of hashes: each element of <code>$parsedEntries</code> is itself a hashtable of recipe attributes (keys) and their values.</li>
      <li><code>$foundEntry</code> (Boolean)<br />
        specifies whether the application is currently processing an entry (<code>true</code>) or another XML tag (<code>false</code>). <code>$foundEntry</code> is set to <code>true</code> when <code>startElement</code> reads an opening <code>ENTRY</code> tag, and set to <code>false</code> when <code>endElement</code> reads a closing <code>ENTRY</code> tag.</li>
      <li><code>$curElement</code> (string): <br />
        denotes the current tag being processed. <code>$curElement</code> is set by <code>startElement()</code>, then used by <code>characterData()</code> to update <code>$parsedEntries</code>.</li>
    </ul>
    <pre>#&nbsp;Callback&nbsp;function&nbsp;that's&nbsp;fired&nbsp;by&nbsp;the&nbsp;Expat&nbsp;XML&nbsp;parser&nbsp;on&nbsp;parsing
#&nbsp;a&nbsp;start&nbsp;tag.
sub&nbsp;handleXMLstart&nbsp;{
&nbsp;&nbsp;my($parser,&nbsp;$elem,&nbsp;%attrs)&nbsp;=&nbsp;@_;

&nbsp;&nbsp;$curElement&nbsp;=&nbsp;lc($elem);
&nbsp;&nbsp;if&nbsp;($curElement&nbsp;eq&nbsp;&quot;entry&quot;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;$foundEntry&nbsp;=&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;push(@parsedEntries,&nbsp;{});
&nbsp;&nbsp;}&nbsp;elsif&nbsp;($foundEntry&nbsp;&amp;&amp;&nbsp;$curElement&nbsp;eq&nbsp;&quot;link&quot;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;$parsedEntries[$#parsedEntries]{$attrs{&quot;rel&quot;}}&nbsp;=&nbsp;$attrs{&quot;href&quot;};
&nbsp;&nbsp;}
}

#&nbsp;Callback&nbsp;function&nbsp;that's&nbsp;fired&nbsp;by&nbsp;the&nbsp;Expat&nbsp;XML&nbsp;parser&nbsp;on&nbsp;parsing
#&nbsp;an&nbsp;end&nbsp;tag.
sub&nbsp;handleXMLend&nbsp;{
&nbsp;&nbsp;my($parser,&nbsp;$elem)&nbsp;=&nbsp;@_;

&nbsp;&nbsp;if&nbsp;(lc($elem)&nbsp;eq&nbsp;&quot;entry&quot;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;$foundEntry&nbsp;=&nbsp;0;
&nbsp;&nbsp;}
}

#&nbsp;Callback&nbsp;function&nbsp;that's&nbsp;fired&nbsp;by&nbsp;the&nbsp;Expat&nbsp;XML&nbsp;parser&nbsp;on&nbsp;parsing
#&nbsp;a&nbsp;sequence&nbsp;of&nbsp;characters.
sub&nbsp;handleXMLchar&nbsp;{
&nbsp;&nbsp;my($parser,&nbsp;$chars)&nbsp;=&nbsp;@_;

&nbsp;&nbsp;if&nbsp;($foundEntry)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;$parsedEntries[$#parsedEntries]{lc($curElement)}&nbsp;=&nbsp;$chars;
&nbsp;&nbsp;}
}</pre>
    <h3><a name="FeedInteract" id="FeedInteract"></a>Interacting with the Google Base feeds</h3>
    <p>This section describes how the Recipe application interacts with the Google Base feed to retrieve, insert, update, and delete items.</p>
    <h4><a name="queryEntries" id="queryEntries"></a>Retrieving the user's entries: <code>getItems()</code></h4>
    <p>The <code>getItems()</code> function, called to create the array of user-entered recipes, uses libcurl to perform an HTTP GET request on the user's items feed (<code>$itemsFeedURL</code>). It has the same basic structure as <code><a href="#exchangeToken">exchangeToken()</a></code> above, with the exception of an added header (<code><a href="http://code.google.com/apis/base/starting-out.html#authDev">X-Google-Key</a></code>) that specifies the application's developer key. After receiving the HTTP response, <code>getItems()</code> calls <code>XML::Parser-&gt;parse()</code> to parse the Atom feed returned by the server.</p>
    <pre>sub&nbsp;getItems&nbsp;{
&nbsp;&nbsp;my&nbsp;$token&nbsp;=&nbsp;shift;
&nbsp;&nbsp;my&nbsp;$curl&nbsp;=&nbsp;new&nbsp;WWW::Curl::Easy;
&nbsp;&nbsp;my&nbsp;@body;

&nbsp;&nbsp;my&nbsp;@authHeader&nbsp;=&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;'Content-Type:&nbsp;application/atom+xml',
&nbsp;&nbsp;&nbsp;&nbsp;'Authorization:&nbsp;AuthSub&nbsp;token=&quot;'&nbsp;.&nbsp;trim($token)&nbsp;.&nbsp;'&quot;',
&nbsp;&nbsp;&nbsp;&nbsp;'X-Google-Key:&nbsp;key='&nbsp;.&nbsp;$developerKey
&nbsp;&nbsp;);

&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_URL,&nbsp;&quot;http://www.google.com/base/feeds/items?&quot;);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_FAILONERROR,&nbsp;1);&nbsp;

&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_WRITEFUNCTION,&nbsp;\&amp;writeCallback&nbsp;);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_HEADERFUNCTION,&nbsp;\&amp;headerCallback&nbsp;);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_FILE,&nbsp;\@body);

&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_FOLLOWLOCATION,&nbsp;1);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_HTTPHEADER,&nbsp;\@authHeader);

&nbsp;&nbsp;my&nbsp;$result&nbsp;=&nbsp;$curl-&gt;perform();
&nbsp;&nbsp;if&nbsp;(!$result)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;my&nbsp;$parser&nbsp;=&nbsp;new&nbsp;XML::Parser(Handlers&nbsp;=&gt;&nbsp;{Start&nbsp;=&gt;&nbsp;\&amp;handleXMLstart,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End&nbsp;&nbsp;&nbsp;=&gt;&nbsp;\&amp;handleXMLend,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Char&nbsp;&nbsp;=&gt;&nbsp;\&amp;handleXMLchar});
&nbsp;&nbsp;&nbsp;&nbsp;$parser-&gt;parse(join(&quot;&quot;,&nbsp;@body));
&nbsp;&nbsp;}
}
</pre>
    <h4><a name="insertEntry" id="insertEntry"></a>Inserting new entries: <code>postItem()</code></h4>
    <p>The <code>postItem()</code> function inserts a new recipe by performing an HTTP POST on the user's items feed. The two curl options of note are: </p>
    <ul>
      <li><code>CURLOPT_UPLOAD</code>, which specifies that data will be uploaded in an HTTP POST;<br />
      </li>
      <li><code>CURLOPT_READFUNCTION</code>, which specifies the callback function that provides the data to POST;</li>
      <li><code>CURLOPT_INFILESIZE</code>, which specifies the length of the data to POST;</li>
    </ul>
    <pre>sub&nbsp;postItem&nbsp;{
&nbsp;&nbsp;my&nbsp;$curl&nbsp;=&nbsp;new&nbsp;WWW::Curl::Easy;
&nbsp;&nbsp;my&nbsp;@body;

&nbsp;&nbsp;my&nbsp;@authHeader&nbsp;=&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;'Content-Type:&nbsp;application/atom+xml',
&nbsp;&nbsp;&nbsp;&nbsp;'Authorization:&nbsp;AuthSub&nbsp;token=&quot;'&nbsp;.&nbsp;param('session_token')&nbsp;.&nbsp;'&quot;',
&nbsp;&nbsp;&nbsp;&nbsp;'X-Google-Key:&nbsp;key='&nbsp;.&nbsp;$developerKey
&nbsp;&nbsp;);

&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_URL,&nbsp;&quot;http://www.google.com/base/feeds/items&quot;);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_READFUNCTION,&nbsp;\&amp;buildInsertXML);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_INFILESIZE,&nbsp;length(buildInsertXML()));
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_UPLOAD,&nbsp;1);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_CUSTOMREQUEST,&nbsp;&quot;POST&quot;);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_FAILONERROR,&nbsp;1);
&nbsp;&nbsp;
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_WRITEFUNCTION,&nbsp;\&amp;writeCallback&nbsp;);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_HEADERFUNCTION,&nbsp;\&amp;headerCallback&nbsp;);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_FILE,&nbsp;\@body);
&nbsp;&nbsp;
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_FOLLOWLOCATION,&nbsp;1);&nbsp;&nbsp;
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_HTTPHEADER,&nbsp;\@authHeader);
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;my&nbsp;$result&nbsp;=&nbsp;$curl-&gt;perform();

&nbsp;&nbsp;return&nbsp;$result;
}</pre>
    <h4><a name="updateEntry" id="updateEntry"></a>Updating existing entries: <code>updateItem()</code></h4>
    <p>The <code>updateItem</code> function updates an existing recipe by performing an HTTP PUT on that recipe's feed URI. This function is identical to <code>postItem()</code> in every respect, except that the custom request is now specified as  PUT instead of POST.</p>
    <pre>sub&nbsp;updateItem&nbsp;{
&nbsp;&nbsp;my&nbsp;$curl&nbsp;=&nbsp;new&nbsp;WWW::Curl::Easy;
&nbsp;&nbsp;my&nbsp;@body;

&nbsp;&nbsp;my&nbsp;@authHeader&nbsp;=&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;'Authorization:&nbsp;AuthSub&nbsp;token=&quot;'&nbsp;.&nbsp;param('session_token')&nbsp;.&nbsp;'&quot;',
&nbsp;&nbsp;&nbsp;&nbsp;'X-Google-Key:&nbsp;key='&nbsp;.&nbsp;$developerKey,
&nbsp;&nbsp;&nbsp;&nbsp;'Content-Type:&nbsp;application/atom+xml'
&nbsp;&nbsp;);

&nbsp;&nbsp;my&nbsp;$feedURL&nbsp;=&nbsp;param('link');
&nbsp;&nbsp;chomp&nbsp;$feedURL;

&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_URL,&nbsp;$feedURL);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_READFUNCTION,&nbsp;\&amp;buildInsertXML);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_INFILESIZE,&nbsp;length(buildInsertXML()));
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_UPLOAD,&nbsp;1);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_CUSTOMREQUEST,&nbsp;&quot;PUT&quot;);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_FAILONERROR,&nbsp;1);
&nbsp;&nbsp;
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_WRITEFUNCTION,&nbsp;\&amp;writeCallback&nbsp;);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_HEADERFUNCTION,&nbsp;\&amp;headerCallback&nbsp;);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_FILE,&nbsp;\@body);
&nbsp;&nbsp;
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_VERBOSE,&nbsp;1);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_FOLLOWLOCATION,&nbsp;1);&nbsp;&nbsp;
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_HTTPHEADER,&nbsp;\@authHeader);
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;my&nbsp;$result&nbsp;=&nbsp;$curl-&gt;perform();

&nbsp;&nbsp;return&nbsp;$result;
}</pre>
    <h4><a name="deleteEntry" id="deleteEntry"></a>Deleting existing entries: <code>deleteItem()</code></h4>
    <p>The <code>deleteItem()</code> function deletes a recipe the user has entered previously by performing an HTTP DELETE on its feed URI. The DELETE command is specified using the option <code>CURLOPT_CUSTOMREQUEST</code> below.</p>
    <pre>sub&nbsp;deleteItem&nbsp;{
&nbsp;&nbsp;my&nbsp;$curl&nbsp;=&nbsp;new&nbsp;WWW::Curl::Easy;
&nbsp;&nbsp;my&nbsp;$feedURL&nbsp;=&nbsp;param('link');
&nbsp;&nbsp;my&nbsp;@body;

&nbsp;&nbsp;my&nbsp;@authHeader&nbsp;=&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;'Authorization:&nbsp;AuthSub&nbsp;token=&quot;'&nbsp;.&nbsp;param('session_token')&nbsp;.&nbsp;'&quot;',
&nbsp;&nbsp;&nbsp;&nbsp;'X-Google-Key:&nbsp;key='&nbsp;.&nbsp;$developerKey
&nbsp;&nbsp;);

&nbsp;&nbsp;chomp&nbsp;$feedURL;
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_URL,&nbsp;$feedURL);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_CUSTOMREQUEST,&nbsp;&quot;DELETE&quot;);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_FAILONERROR,&nbsp;1);
&nbsp;&nbsp;
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_WRITEFUNCTION,&nbsp;\&amp;writeCallback&nbsp;);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_HEADERFUNCTION,&nbsp;\&amp;headerCallback&nbsp;);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_FILE,&nbsp;\@body);
&nbsp;&nbsp;
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_FOLLOWLOCATION,&nbsp;1);&nbsp;&nbsp;
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_HTTPHEADER,&nbsp;\@authHeader);
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;my&nbsp;$result&nbsp;=&nbsp;$curl-&gt;perform();

&nbsp;&nbsp;return&nbsp;$result;
}</pre>
    <h4><a name="batchCommand" id="batchCommand"></a>Executing a batch command: <code>batchDelete()</code></h4>
    <p>The <code>batchDelete()</code> function deletes all of the user's recipes by issuing a batch request to the Google Base API. This is accomplished by performing an HTTP POST (specified by the <code>POST</code> custom request) to the batch feed URL, specifying <a href="#deleteXML">the batch XML document</a> as POST data.</p>
    <pre>sub&nbsp;batchDelete&nbsp;{
&nbsp;&nbsp;my&nbsp;$curl&nbsp;=&nbsp;new&nbsp;WWW::Curl::Easy;
&nbsp;&nbsp;my&nbsp;@body;

&nbsp;&nbsp;my&nbsp;@authHeader&nbsp;=&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;'Content-Type:&nbsp;application/atom+xml',
&nbsp;&nbsp;&nbsp;&nbsp;'Authorization:&nbsp;AuthSub&nbsp;token=&quot;'&nbsp;.&nbsp;param('session_token')&nbsp;.&nbsp;'&quot;',
&nbsp;&nbsp;&nbsp;&nbsp;'X-Google-Key:&nbsp;key='&nbsp;.&nbsp;$developerKey
&nbsp;&nbsp;);

&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_URL,&nbsp;&quot;http://www.google.com/base/feeds/items/batch&quot;);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_READFUNCTION,&nbsp;\&amp;buildBatchDeleteXML);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_INFILESIZE,&nbsp;length(buildBatchDeleteXML()));
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_UPLOAD,&nbsp;1);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_CUSTOMREQUEST,&nbsp;&quot;POST&quot;);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_FAILONERROR,&nbsp;1);
&nbsp;&nbsp;
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_WRITEFUNCTION,&nbsp;\&amp;writeCallback&nbsp;);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_HEADERFUNCTION,&nbsp;\&amp;headerCallback&nbsp;);
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_FILE,&nbsp;\@body);
&nbsp;&nbsp;
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_FOLLOWLOCATION,&nbsp;1);&nbsp;&nbsp;
&nbsp;&nbsp;$curl-&gt;setopt(CURLOPT_HTTPHEADER,&nbsp;\@authHeader);
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;my&nbsp;$result&nbsp;=&nbsp;$curl-&gt;perform();

&nbsp;&nbsp;return&nbsp;$result;
}</pre>
    <h2>Troubleshooting<a name="troubleshooting" id="troubleshooting"></a></h2>
    <p>Can't get the Perl sample code to work on your server? Here are a few suggestions:</p>
    <ul>
      <li>Verify that you are using a valid <a href="../../signup.html">developer key</a> that is tied to your domain.</li>
      <li>Try using <code><a href="http://search.cpan.org/~crisb/WWW-Curl-3.02/Easy.pm.in#METHODS">$curl-&gt;errbuf</a></code> to drill down and see exactly what error is occurring.&nbsp; For example:<br />
        <br />
        <pre>if ($curl-&gt;perform() != 0) { <br />   print &quot;Error: &quot; . $curl-&gt;errbuf . &quot;\n&quot;;<br />};</pre>
      </li>
    </ul>
    <p>&nbsp;</p>
  </div>
  <!-- ########## END PAGE CONTENT ########## -->
</div>
<!-- end wrapper -->
<div id="footer">
  <!-- ########## PAGE FOOTER ########## -->
  <div id="footerlogo"><img src="http://www.google.com/images/art.gif" /></div>
  <div id="copyright">
    <p>&copy;2007 Google - <a href="http://www.google.com/privacy.html">Privacy
      Policy</a> - <a href="http://www.google.com/terms_of_service.html">Terms
      and Conditions</a> - <a href="http://www.google.com/about.html">About
      Google</a></p>
  </div>
  <!-- end copyright -->
</div>
<!-- ########## END PAGE FOOTER ########## -->
<p id="date"> Updated on
  <!-- javascript to display the date this page was updated -->
  <script type="text/javascript">
<!-- hide script from old browsers
    var lm = new Date(document.lastModified);
    document.write(lm.toDateString());
//-->
</script>
  <!-- end javascript -->
</p>
<script
  src="http://www.google-analytics.com/urchin.js"
  type="text/javascript">
</script>
<script type="text/javascript">
  _uacct="UA-18071-1";
  urchinTracker();
</script>
</body>
</html>
