<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="stylesheet" type="text/css" href="../../../css/google.css" />
<link rel="stylesheet" type="text/css" href="../../../css/dev_docs.css" />
<link rel="stylesheet" type="text/css" href="../../local_extensions.css" />
<!--[if IE 7]>
  <link rel="stylesheet" type="text/css" href="../../../css/ie7only.css" />
<![endif]-->
<!--[if lte IE 6]>
  <link rel="stylesheet" type="text/css" href="../../../css/ie6only.css" />
<![endif]-->
<!--[if IE]>
  <link rel="stylesheet" type="text/css" href="../../../css/ieonly.css" />
<![endif]-->
<title>Google Base data API- Understanding the Java Recipe Sample Application</title>
</head>
<body id="sample_page">
<a name="top" id="top"></a>
<!-- ########## PAGE HEADER ########## -->
<div id="header">
  <div id="logo"><a href="http://code.google.com/"><img src="http://code.google.com/images/code_sm.png" border="0" alt="Return to Google Code homepage" /></a></div>
  <h1 id="doc_title">Google Base data API</h1>
</div>
<!-- ########## END PAGE HEADER ########## -->
<div id="wrapper">
  <!-- ########## SIDE NAVIGATION ########## -->
    <div id="sidenav"> <!-- ID tag identifies current page -->

<ul>
  <li><a href="http://base.google.com/base">Base Home</a></li>
  <li><a href="../../index.html" id="index_link">Base API Home</a></li>
</ul>
<ul>
  <li>
    <h1>Getting Started</h1>
    <ul>
      <li><a href="http://www.google.com/base/api/demo/html/demo.html" id="demo_link">API Demo Page</a> </li>
      <li><a href="../../sample-apps.html" id="sample_link">Sample Applications</a></li>
      <li><a href="../../starting-out.html" id="start_link">Getting Started</a></li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <h1>Developer's Guide</h1>
    <ul>
      <li><a href="../../attrs-queries.html" id="attsquer_link">Attributes and Queries</a></li>
      <li><a href="http://code.google.com/apis/gdata/index.html">GData Developer's Guide</a></li>
      <li><a href="../../javadevguide.html" id="javaDev_link">Java Developer's Guide</a></li>
      <li><a href="../../csharpdevguide.html" id="cSharpDev_link">C# Developer's Guide</a></li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <h1>Reference</h1>
    <ul>
      <li><a href="http://base.google.com/base/api/itemTypeDocs" id="itemType_link">Recommended
        Attributes</a></li>
      <li><a href="../../snippets-feed.html" id="snippets_link">Snippets
        Feed</a></li>
      <li><a href="../../items-feed.html" id="items_link">Customer Items
        Feed</a></li>
      <li><a href="../../attributes-feed.html" id="attributes_link">Attributes
        Feed</a></li>
      <li><a href="../../itemtypes-feed.html" id="itemtypes_link">Item Types
        Feed</a></li>
      <li><a href="../../locales-feed.html" id="locales_link">Locales Feed</a></li>
      <li><a href="../../query-lang-spec.html" id="query_link">Query Language</a></li>
      <li><a href="../../ranking-lang-spec.html" id="ranking_link">Expression Language</a></li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <h1>Related Links</h1>
    <ul>
      <li><a href="../../client-download.html" id="clientdownload_link">Client
        Library </a></li>
      <li><a href="../../signup.html" id="signup_link">API Key</a></li>
      <li><a href="../../terms.html" id="terms_link">Terms of Use</a></li>
      <li><a href="../../release-notes.html" id="rnotes_link">Release Notes </a></li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <h1>Help Center</h1>
    <ul>
      <li><a href="http://base.google.com/support/bin/topic.py?topic=9231">FAQ</a></li>
      <li><a href="http://groups.google.com/group/Google-Base-data-API">Developer Forum</a></li>
      <li><a href="http://code.google.com/support/bin/topic.py?topic=10024">Knowledge Base</a> </li>
      <li><a href="http://base.google.com/base/base_policies.html">Program Policies</a></li>
      </ul>
  </li>
</ul>
<form action="http://www.google.com/search" method="get" id="searchbox" style="font-size: 80%; margin-bottom: 0;">
  <input type="text" name="q" size="15" id="searchinput" title="Search developer's guide" style="font-size: 100%;"
		onfocus="clearDefaultValue(this);"/>
  <!-- This comment prevents 
	space-->
  <input type="submit" name="submit" value="Go" title="" style="font-size: 90%;"/>
  <input type="hidden" name="ie" value="UTF-8"/>
  <input type="hidden" name="oe" value="UTF-8"/>
  <input type="hidden" name="sitesearch" value="http://code.google.com/apis/base/"/>
  <input type="hidden" name="domains" value="http://code.google.com/apis/base/"/>
</form>
 </div>
  <!-- ########## END SIDE NAVIGATION ########## -->
<div id="pagecontent">
    <!-- ########## PAGE CONTENT ########## -->
    <h2 id="page_title">Understanding the Java Recipe Sample Application </h2>
    <p><strong>Select a language:</strong> |<activeLang> Java </activelang>
      | <a href="../javascript/javascript-sample.html">JavaScript</a> | <a href="../perl/perl-sample.html">Perl</a> | <a href="../php/php-sample-zend.html">PHP</a> | <a href="../python/python-sample.html">Python</a> | <a href="../csharp/csharp-sample.html">C#</a> | <a href="../vb/vb-sample.html">VB.NET</a> | <a href="../coldfusion/coldfusion-sample.html">ColdFusion</a> </p>
    <p id="langSelect"> <a href="java-sample.html">Java Sample Home</a> <strong>Recipe</strong> <a href="java-sample-query.html">QueryExample</a> <a href="java-sample-customertool.html">CustomerTool</a> </p>
	  <p>The Recipe application is a small but complete Java servlet that queries for recipes. It gives you an idea of how to construct an application that can run with
      Google Base queries. </p>
	  <h3>Contents</h3>
      <ol class="toc">
        <li><a href="#usingRecipe">Using the Recipe Application </a>          </li>
        <li><a href="#RSstepThru">Stepping through  the Recipe application code</a>          
          <ol class="toc">
            <li><a href="#authUsers">Authenticating users</a></li>
            <li><a href="#getRecipe">Displaying a recipe</a></li>
            <li><a href="#runRecipe">Running queries</a></li>
            <li><a href="#insertRecipe">Inserting and updating items</a></li>
          </ol></li>
        
    </ol>
 
      <h2><a name="usingRecipe" id="usingRecipe"></a>Using the Recipe application </h2>
      <p>You can run the Recipe application as a demo at <a href="http://base.google.com/base/api/demo/recipe/" target="_blank">http://base.google.com/base/api/demo/recipe/</a></p>
      <p>Alternately, you can install and run the web application in <code>/java/sample/gbase/lib/gdata-base-recipe.war</code>        on any application server that supports at least JSP 1.2 and Servlets
        2.3, running under java 5. Follow the instructions provided by your application
        server vendor. <br/>
          <br/>
        Here are step-by-step instructions for downloading Tomcat 5 and installing
    the recipe application:</p>
      <ol>
        <li>Download Tomcat from <a onclick="return top.js.OpenExtLink(window,event,this)" href="http://www.google.com/url?sa=D&amp;q=http%3A%2F%2Ftomcat.apache.org%2Fdownload-55.cgi" target="_blank">http://tomcat.apache.org<wbr>/download-55.cgi</a></li>
        <li>Unpack the distribution</li>
        <li>Copy the war file (<code>/java/sample/gbase/lib/gdata-base-recipe.war</code>) into Tomcat's <code>webapps</code> directory
          and rename it <code>recipe.war</code></li>
        <li>Run tomcat (<code>bin/catalina.sh run</code>)</li>
        <li>Open the URL <a onclick="return top.js.OpenExtLink(window,event,this)" href="http://www.google.com/url?sa=D&amp;q=http%3A%2F%2Flocalhost%3A8080%2Frecipe%2F" target="_blank">http://localhost:8080/recipe/</a></li>
      </ol>
      <h2><a name="RSstepThru" id="RSstepThru"></a>Stepping through   the Recipe application code </h2>
      <p>Most of the code and all of the JSPs in the Recipe sample application
        use standard J2EE features (<a href="http://www.google.com/url?sa=D&amp;q=http%3A%2F%2Fjava.sun.com%2Fjavaee%2Findex.jsp" target="_blank">http://java.sun.com/javaee</a>).
        You need to be familiar with servlets and JSPs to understand what it
        does. This section discusses the classes that contain the code required
        for a web application to access Google Base. </p>
      <h3><a name="authUsers" id="authUsers"></a>Authenticating users:<code> AuthenticationFilter</code> </h3>
      <p>The key area for Google Base web applications is managing authentication
        correctly. Google has an authentication system that allows applications
        to use an authentication proxy interface called AuthSub to handle Google
        Base items on behalf of their users without ever knowing the user's password.
        Using the proxy, a user of the web application logs into their Google
        account and consents to grant limited access to the web application.
        For further information on how AuthSub works, refer to the <a href="../../starting-out.html#authUser">AuthSub</a> documentation and the <a href="../../javadevguide.html#authentication">Java Client Library Developer's Guide</a>. </p>
      <p>In the recipe code, an <code> AuthenticationFilter </code> object creates
        and configures a GoogleBaseService as required by the AuthSub protocol.
        The first time a page protected by the filter, <code> AuthenticationFilter.doFilter </code> redirects
        the call to <a href="https://www.google.com/accounts/" target="_blank">https://www.google.com/accounts/.</a> Once
        the user has successfully logged in and allowed the web application to
        access their data, the Google authentication server forwards the browser
        back to the web application:</p>
      <pre>private void redirectToAuthSub(HttpServletRequest request, HttpServletResponse response)  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws IOException { 
&nbsp;&nbsp;&nbsp; StringBuffer next = request.getRequestURL(); 
&nbsp;&nbsp;&nbsp; String queryString = request.getQueryString(); 
&nbsp;&nbsp; &nbsp;if (queryString != null &amp;&amp; !&quot;&quot;.equals(queryString) ) { 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; next.append(&quot;?&quot;).append(queryString); 

&nbsp;&nbsp;&nbsp; } 
&nbsp;&nbsp;&nbsp; String scope = new URL(urlFactory.getBaseURL(), &quot;feeds&quot;).toExternalForm(); 
&nbsp;&nbsp;&nbsp; String url = AuthSubUtil.getRequestUrl(authsubProtocol, 
                                authsubHostname,          
                                next.toString(),
                                scope,  
                                false, 
                                true); 
&nbsp;&nbsp;&nbsp; response.sendRedirect(response.encodeRedirectURL(url)); 
} </pre>
      <p>The second time a page protected by <code>AuthenticationFilter</code> is
        called, the request needs to contain the <code>token</code> parameter,
        which is a single-use token generated by the Google authentication server. </p>
      <p>In the following code, the filter: </p>
      <ul>
        <li>connects to <a href="https://www.google.com/accounts/" target="_blank">https://www.google.com/accounts/</a> to
          convert the single-use token into a multiple-use token</li>
        <li>stores the token into a cookie, and </li>
        <li>redirects to the initial URL</li>
      </ul>
       <pre>
 private void startAuthenticatedSession(HttpServletRequest request,
                                        HttpServletResponse response,
                                        String oneTimeToken)
     throws IOException, GeneralSecurityException, AuthenticationException,
     ServletException {
   String sessionToken = exchangeForSessionToken(oneTimeToken);
   
   // Store the authentication token in a cookie
   response.addCookie(newSessionTokenCookie(request, sessionToken));
   
   // Redirect the browser to the same address
   // with the "token=value" part removed from the query string
   StringBuffer url = request.getRequestURL();    
   String queryString = request.getQueryString();
   if (queryString != null) {
     queryString = queryString.replaceFirst("token=[^&]*&?", "");
     if (queryString.length() > 0) {
       url.append("?").append(queryString);
     }
   }
   response.sendRedirect(response.encodeRedirectURL(url.toString()));
 }
 
 protected String exchangeForSessionToken(String oneTimeToken)
     throws IOException, GeneralSecurityException, AuthenticationException {
   return AuthSubUtil.exchangeForSessionToken(authsubProtocol,
                                              authsubHostname,
                                              oneTimeToken,
                                              null);
 }
 </pre>      
      <p>At this point, each time <code>AuthenticationFilter</code> is called,
        it:</p>
      <ul>
        <li>gets the multi-use token from the cookie</li>
        <li>puts that into every request it makes to Google Base</li>
        <li>passes it to the GoogleBaseService object it creates</li>
        <li>executes the servlet code using <code> filterChain.doFilter. </code> </li>
      </ul>
      <p>Servlets will find the GoogleBaseService object to use in a request attribute
        set by this filter.</p>
      <pre>GoogleBaseService service = new GoogleBaseService( 
&nbsp;&nbsp;&nbsp; applicationName, key, authsubProtocol, authsubHostname); 
service.setAuthSubToken(sessionToken); 
// Make the service available to the servlet 
httpRequest.setAttribute(SERVICE_ATTRIBUTE, service); 

// Execute the servlet
filterChain.doFilter(request, response);</pre>
      <p>Servlets that don't access protected feeds don't need <code> AuthenticationFilter</code>.
        They can create their own GoogleBaseService object and not set the AuthSub
        token. </p>
      <p class="backtotop"><a href="#top">Back to top</a></p>
      <h3><a name="getRecipe" id="getRecipe"></a>Displaying a recipe - <code>RecipeDisplayServlet.java</code> / <code>Recipe.java</code></h3>
      <p>This servlet gets the snippet of a specific query and sends the result
        to a JSP for it to be displayed. Flattened and simplified, the code in
        this servlet executes the following actions:</p>
      <pre>GoogleBaseService service = new GoogleBaseService(applicationName, developerKey);
URL feedUrl = urlFactory.getSnippetsEntryURL(id);
entry = service.getEntry(feedUrl);
Recipe recipe = new Recipe(entry);</pre>
      <p>This code performs these actions:</p>
      <ul>
        <li>first creates a GoogleBaseService object</li>
        <li>gets the URL of a recipe given its numerical ID that was passed to
          the servlet as a parameter</li>
        <li>converts it into a GoogleBaseEntry object </li>
        <li>creates a Recipe object from it. </li>
      </ul>
      <p>The Recipe class is a simple application-specific wrapper around a Google
        Base recipe. It shields the rest of the application from the Google Base
        library and contains some logic specific to recipes. The most interesting
        methods of the Recipe class are its constructor and the method <code> toGoogleBaseEntry()</code>.
        Here's the constructor:</p>
      <pre>public Recipe(GoogleBaseEntry entry) { 
  id = extractIdFromUrl(entry.getId()); 
  title = entry.getTitle().getPlainText(); 
  url = entry.getHtmlLink().getHref(); 
  String description = null; 
  if (entry.getContent() != null) { 
    Content content = entry.getContent(); 
    if (content instanceof TextContent) { 
      description = ((TextContent)content).getContent().getPlainText(); 
    } else if (content instanceof OtherContent) { 
    &nbsp; description = ((OtherContent)content).getText(); 
    &nbsp;&nbsp; } 
&nbsp;&nbsp;&nbsp; }  
  &nbsp;&nbsp;...</pre>
      <p>Here's the <code>toGoogleBaseEntry()</code> method:</p>
      <pre>public GoogleBaseEntry toGoogleBaseEntry(String idUrl) 
{ 
  GoogleBaseEntry entry = new GoogleBaseEntry(); 
  entry.getGoogleBaseAttributes().setItemType(RECIPE_ITEMTYPE); 
  if (idUrl != null) { 
    entry.setId(idUrl); 
  } 
  entry.setTitle(TextConstruct.create(TextConstruct.Type.TEXT, title, null)); 
  if (url != null) { 
     entry.addHtmlLink(url, null, null); 
  } 
  if (description != null) { 
      // If the original content was not TEXT, the formatting is lost 
      entry.setContent( 
          TextConstruct.create(TextConstruct.Type.TEXT, description, null)); 
  } 
  ...</pre>
      <p>The <code>toGoogleBaseEntry()</code> method converts the GoogleBaseEntry
        into a Recipe and then back into a GoogleBaseEntry object.</p>
      <h3><a name="runRecipe" id="runRecipe"></a>Running queries - <code>RecipeSearchServlet.java</code> / <code>RecipeSearch.java</code></h3>
      <p>The Recipe servlet performs these actions:</p>
      <ul>
        <li>executes a search </li>
        <li>reads the result</li>
        <li>converts it into Recipe object</li>
        <li>passes this object to a JSP file for it to be displayed. </li>
      </ul>
      <p>The most interesting code is in <code> RecipeSearch.runQuery()</code> where
        a query is created with <code> RecipeSearch.createQueryString()</code> and
        then executed using <code>GoogleBaseService.query()</code>. <code>The
          RecipeSearch.createQuery()</code> method creates the query and handles
        paging using <code>GoogleBaseQuery.setMaxResults() </code> to set the
        page length and <code>GoogleBaseQuery.setStartIndex()</code> to set the
        current page:</p>
      <pre>GoogleBaseQuery query = new GoogleBaseQuery(queryUrl); 
query.setMaxResults(maxResults); 
if (startIndex &gt; 0) { 
&nbsp; // the first index is 1 
&nbsp; query.setStartIndex(startIndex + 1); 
}</pre>
      <p>The query string is then created in <code> RecipeSearch.createQueryString</code> and
        passed to the query object, which is executed by <code> GoogleBaseService.query()</code> : </p>
      <pre>public void runQuery() throws IOException, ServiceException { 
&nbsp; GoogleBaseQuery query = createQuery(); 
  System.out.println(&quot;Searching: &quot; + query.getUrl()); 
&nbsp; GoogleBaseFeed feed = service.query(query); 
&nbsp; List result = new ArrayList(maxResults); 
&nbsp; for (GoogleBaseEntry entry : feed.getEntries()) { 
 &nbsp;&nbsp; result.add(new Recipe(entry)); 
&nbsp; } 
  this.recipes = result; 

&nbsp; total = feed.getTotalResults(); 
}</pre>
      <p>Just as in the display servlets, GoogleBaseEntry objects are immediately
        converted into Recipe objects.</p>
      <p>Note: In some cases, the results returned by the Recipe application may
        not appear to match the query. This is because the application doesn't
        always show the entire document, so there may be attributes that are
        not shown that match the query. </p>
      <h3><a name="insertRecipe" id="insertRecipe"></a>Inserting and updating recipes
        - <code>RecipeActionServlet.java</code></h3>
      <p>When adding a new recipe, the application first creates and initializes
        a Recipe object. When this object has been completely initialized, the
        servlet can insert it into Google Base. This is done in <code> RecipeActionServlet.recipeAdd()</code>:</p>
      <pre>
protected void recipeAdd(GoogleBaseService service, 
                         Recipe recipe)  
  throws IOException, ServiceException { 
  URL feedUrl = urlFactory.getItemsFeedURL(); 
  GoogleBaseEntry entry = recipe.toGoogleBaseEntry(null); 
  service.insert(feedUrl, entry); 
}</pre>
      <p>Updating a recipe works the same way. The big difference is that the Recipe
        object has been created from an old GoogleBaseEntry and already has an
        ID: </p>
      <pre>
protected void recipeUpdate(GoogleBaseService service,
		                      Recipe recipe) 
  throws ServiceException, IOException {
  URL feedUrl = urlFactory.getItemsEntryURL(recipe.getId());
  GoogleBaseEntry entry = recipe.toGoogleBaseEntry(feedUrl.toString());
  service.update(feedUrl, entry);
}</pre>
<p align="right">Go to <a href="java-sample-query.html">QueryExample</a></p>
  </div>
  <!-- ########## END PAGE CONTENT ########## -->
</div>
<!-- end wrapper -->
<div id="footer">
  <!-- ########## PAGE FOOTER ########## -->
  <div id="footerlogo"><img src="http://www.google.com/images/art.gif" /></div>
  <div id="copyright">
    <p>&copy;2007 Google - <a href="http://www.google.com/privacy.html">Privacy
      Policy</a> - <a href="http://www.google.com/terms_of_service.html">Terms
      and Conditions</a> - <a href="http://www.google.com/about.html">About
      Google</a></p>
  </div>
  <!-- end copyright -->
</div>
<!-- ########## END PAGE FOOTER ########## -->
<p id="date"> Updated on
  <!-- javascript to display the date this page was updated -->
  <script type="text/javascript">
<!-- hide script from old browsers
    var lm = new Date(document.lastModified);
    document.write(lm.toDateString());
//-->
</script>
  <!-- end javascript -->
</p>
<script
  src="http://www.google-analytics.com/urchin.js"
  type="text/javascript">
</script>
<script type="text/javascript">
  _uacct="UA-18071-1";
  urchinTracker();
</script>
</body>
</html>
